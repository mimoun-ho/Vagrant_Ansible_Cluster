#!/bin/bash
# Configuration initiale
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_new -N ""
START=101
END=110
SUBNET="192.168.50"
USERNAME="ansible"
PASSWORD="ansible"  # Assurez-vous de sécuriser l'utilisation des mots de passe dans les scripts
INVENTORY_FILE="inventory.ini"
TEMP_INVENTORY="temp_inventory.ini"

# Crée un fichier temporaire pour stocker les nouvelles entrées
> "$TEMP_INVENTORY"

# Vérifie le groupe [node_list]
if ! grep -q "\[node_list\]" "$INVENTORY_FILE"; then
    echo "[node_list]" >> "$TEMP_INVENTORY"
fi

# Boucle sur la plage d'adresses IP
for IP in $(seq $START $END); do
    FULL_IP="$SUBNET.$IP"
    echo "Vérification de la joignabilité de $FULL_IP par ping..."
    
    if ping -c 1 $FULL_IP &> /dev/null; then
        echo "$FULL_IP est joignable."
        
        # Tentative de copie de la clé SSH vers le hôte distant
        echo "Tentative de copie de la clé SSH vers $FULL_IP"
        sshpass -p "$PASSWORD" ssh-copy-id -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa_new.pub $USERNAME@$FULL_IP
        
        # Utilise sshpass et ssh pour récupérer le nom d'hôte réel
        HOSTNAME=$(sshpass -p "$PASSWORD" ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa_new $USERNAME@$FULL_IP 'hostname' 2>/dev/null)
        
        if [ ! -z "$HOSTNAME" ]; then
            echo "Le nom d'hôte de $FULL_IP est $HOSTNAME."
            # Met à jour le fichier temporaire avec le nom d'hôte réel et les informations SSH
            echo "$HOSTNAME ansible_host=$FULL_IP ansible_user=$USERNAME" >> "$TEMP_INVENTORY"
        else
            echo "Échec de la récupération du nom d'hôte pour $FULL_IP."
        fi
    else
        echo "$FULL_IP n'est pas joignable via ping."
    fi
done

# Remplace l'ancien fichier d'inventaire par le nouveau
mv "$TEMP_INVENTORY" "$INVENTORY_FILE"

echo "Fichier d'inventaire mis à jour : $INVENTORY_FILE"
